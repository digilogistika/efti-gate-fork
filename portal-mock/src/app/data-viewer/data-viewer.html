@if (eftiData) {
  <div class="p-4 md:p-6 bg-gray-50/70 space-y-6">

    <!-- Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Column -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Participants Card -->
        <div (click)="openModal('participants')" class="bg-white p-5 rounded-xl shadow-lg border border-gray-200/50 hover:shadow-xl hover:border-indigo-300 transition-all duration-300 cursor-pointer">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Participants</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Consignor</h4>
              <p class="text-lg font-medium text-gray-900 truncate" [title]="eftiData.consignor?.name?.[0]">{{ eftiData.consignor?.name?.[0] || 'N/A' }}</p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Consignee</h4>
              <p class="text-lg font-medium text-gray-900 truncate" [title]="eftiData.consignee?.name?.[0]">{{ eftiData.consignee?.name?.[0] || 'N/A' }}</p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Carrier</h4>
              <p class="text-lg font-medium text-gray-900 truncate" [title]="eftiData.carrier?.name?.[0]">{{ eftiData.carrier?.name?.[0] || 'N/A' }}</p>
            </div>
          </div>
          @if(otherPartiesCount > 0) {
            <div class="text-right text-indigo-600 font-semibold text-sm mt-2">+{{ otherPartiesCount }} more</div>
          }
        </div>

        <!-- Journey Card -->
        <div (click)="openModal('journey')" class="bg-white p-5 rounded-xl shadow-lg border border-gray-200/50 hover:shadow-xl hover:border-indigo-300 transition-all duration-300 cursor-pointer">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Journey</h3>
          <div class="flex items-center space-x-4">
            <div class="flex-1">
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Place of Taking Over</h4>
              <p class="text-lg font-medium text-gray-900">{{ eftiData.carrierAcceptanceLocation?.name?.[0] || 'N/A' }}</p>
            </div>
            <svg class="w-8 h-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" /></svg>
            <div class="flex-1 text-right">
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Place of Delivery</h4>
              <p class="text-lg font-medium text-gray-900">{{ eftiData.consigneeReceiptLocation?.name?.[0] || 'N/A' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-6">
        <!-- Goods Overview Card -->
        <div (click)="openModal('goods')" class="bg-white p-5 rounded-xl shadow-lg border border-gray-200/50 hover:shadow-xl hover:border-indigo-300 transition-all duration-300 cursor-pointer h-full flex flex-col justify-between">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Goods Overview</h3>
          <div class="text-center space-y-3">
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Total Gross Weight</h4>
              <p class="text-2xl font-light text-gray-900">{{ eftiData.grossWeight?.[0]?.value || 'N/A' }} <span class="text-base">{{ eftiData.grossWeight?.[0]?.unitCode }}</span></p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Total Packages</h4>
              <p class="text-2xl font-light text-gray-900">{{ eftiData.numberOfPackages || 'N/A' }}</p>
            </div>
          </div>
          @if(eftiData.dangerousGoods || (eftiData.includedConsignmentItem | json)!.includes('transportDangerousGoods')) {
            <div class="mt-4 p-2 text-center bg-red-100 border border-red-200 rounded-lg">
              <p class="font-bold text-red-700">[!] DANGEROUS GOODS PRESENT</p>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Logistics Gateway Cards -->
    <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200/50">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Logistics & Financial Details</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <div (click)="openModal('equipment')" class="text-center p-4 bg-gray-50/70 rounded-lg border border-gray-200/80 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all">
          <p class="text-3xl font-bold text-indigo-600">{{ eftiData.usedTransportEquipment?.length || 0 }}</p>
          <p class="text-sm font-semibold text-gray-700 mt-1">Transport Equipment</p>
        </div>
        <div (click)="openModal('documents')" class="text-center p-4 bg-gray-50/70 rounded-lg border border-gray-200/80 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all">
          <p class="text-3xl font-bold text-indigo-600">{{ eftiData.associatedDocument?.length || 0 }}</p>
          <p class="text-sm font-semibold text-gray-700 mt-1">Associated Documents</p>
        </div>
        <div (click)="openModal('charges')" class="text-center p-4 bg-gray-50/70 rounded-lg border border-gray-200/80 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all">
          <p class="text-3xl font-bold text-indigo-600">{{ eftiData.applicableServiceCharge?.length || 0 }}</p>
          <p class="text-sm font-semibold text-gray-700 mt-1">Service Charges</p>
        </div>
        <div (click)="openModal('movements')" class="text-center p-4 bg-gray-50/70 rounded-lg border border-gray-200/80 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all">
          <p class="text-3xl font-bold text-indigo-600">{{ allMovements.length || 0 }}</p>
          <p class="text-sm font-semibold text-gray-700 mt-1">Transport Movements</p>
        </div>
      </div>
    </div>


    <!-- MODALS SECTION -->
    @if(activeModal) {
      <div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40" (click)="closeModal()"></div>
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-h-[90vh] w-full max-w-4xl flex flex-col">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-4 border-b flex-shrink-0">
            <!-- UPDATED: Consolidated Back Button Logic -->
            <div class="flex-1">
              @if(modalDetailView === 'detail' && activeModal === 'equipment' && selectedCarriedEquipment) {
                <!-- Special case for drill-down -->
                <button (click)="goBackToMainEquipment()" class="flex items-center gap-2 px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">
                  &larr; Back to Main Equipment
                </button>
              } @else if (modalDetailView === 'detail' && (activeModal === 'equipment' || activeModal === 'documents' || activeModal === 'charges' || activeModal === 'movements')) {
                <!-- Generic back to list button -->
                <button (click)="goBackToList()" class="flex items-center gap-2 px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">
                  &larr; Back to List
                </button>
              }
            </div>

            <h2 class="text-2xl font-bold text-gray-800 text-center flex-1 mx-4">
              @switch(activeModal) {
                @case('equipment') { Transport Equipment }
                @case('documents') { Associated Documents }
                @case('charges') { Service Charges }
                @case('movements') { Transport Movements }
                @case('participants') {
                  <div class="flex flex-col">
                    <!-- Tab Headers -->
                    <div class="flex border-b border-gray-200 mb-4">
                      <button (click)="selectParticipantTab('consignor')"
                              [class.border-indigo-500]="participantTab === 'consignor'"
                              [class.text-indigo-600]="participantTab === 'consignor'"
                              [class.text-gray-500]="participantTab !== 'consignor'"
                              class="px-4 py-2 font-semibold border-b-2 hover:border-indigo-400 hover:text-indigo-500 transition-colors duration-200 -mb-px">
                        Consignor
                      </button>
                      <button (click)="selectParticipantTab('consignee')"
                              [class.border-indigo-500]="participantTab === 'consignee'"
                              [class.text-indigo-600]="participantTab === 'consignee'"
                              [class.text-gray-500]="participantTab !== 'consignee'"
                              class="px-4 py-2 font-semibold border-b-2 hover:border-indigo-400 hover:text-indigo-500 transition-colors duration-200 -mb-px">
                        Consignee
                      </button>
                      <button (click)="selectParticipantTab('carrier')"
                              [class.border-indigo-500]="participantTab === 'carrier'"
                              [class.text-indigo-600]="participantTab === 'carrier'"
                              [class.text-gray-500]="participantTab !== 'carrier'"
                              class="px-4 py-2 font-semibold border-b-2 hover:border-indigo-400 hover:text-indigo-500 transition-colors duration-200 -mb-px">
                        Carrier
                      </button>
                      @if(allOtherParties.length > 0) {
                        <button (click)="selectParticipantTab('others')"
                                [class.border-indigo-500]="participantTab === 'others'"
                                [class.text-indigo-600]="participantTab === 'others'"
                                [class.text-gray-500]="participantTab !== 'others'"
                                class="px-4 py-2 font-semibold border-b-2 hover:border-indigo-400 hover:text-indigo-500 transition-colors duration-200 -mb-px">
                          Other Parties ({{ allOtherParties.length }})
                        </button>
                      }
                    </div>

                    <!-- Tab Content -->
                    <div class="py-4">
                      @switch(participantTab) {
                        @case('consignor') {
                          <ng-container *ngTemplateOutlet="partyDetails; context: { $implicit: eftiData.consignor, title: 'Consignor Details' }"></ng-container>
                        }
                        @case('consignee') {
                          <ng-container *ngTemplateOutlet="partyDetails; context: { $implicit: eftiData.consignee, title: 'Consignee Details' }"></ng-container>
                        }
                        @case('carrier') {
                          <ng-container *ngTemplateOutlet="partyDetails; context: { $implicit: eftiData.carrier, title: 'Carrier Details' }"></ng-container>
                        }
                        @case('others') {
                          <div class="space-y-4">
                            @for(party of allOtherParties; track party.id?.value) {
                              <ng-container *ngTemplateOutlet="partyDetails; context: { $implicit: party, title: 'Associated Party Details' }"></ng-container>
                            }
                          </div>
                        }
                      }
                    </div>
                  </div>

                }                @case('journey') { Journey Details }
                @case('goods') { Goods Details }
              }
            </h2>

            <div class="flex-1 text-right">
              <button (click)="closeModal()" class="p-2 rounded-full hover:bg-gray-200 text-2xl leading-none">&times;</button>
            </div>
          </div>

          <!-- Modal Content -->
          <div class="p-6 overflow-y-auto">

            <!-- LIST VIEW -->
            @if(modalDetailView === 'list') {
              @switch(activeModal) {
                @case('equipment') {
                  <h3 class="font-bold mb-2 text-gray-700">Equipment List</h3>
                  @for(item of eftiData.usedTransportEquipment; track item.id?.value) {
                    <div (click)="selectEquipment(item)" class="p-3 rounded-md cursor-pointer hover:bg-indigo-50 mb-2 border hover:border-indigo-200 transition-colors">
                      <p class="font-semibold text-indigo-800">{{ item.id?.value || ('Equipment ' + $index) }}</p>
                      <p class="text-sm text-gray-600">{{item.categoryCode}} / {{item.sizeTypeCode}}</p>
                    </div>
                  } @empty { <p class="text-gray-500 text-center p-4">No transport equipment found.</p> }
                }
                @case('documents') {
                  <h3 class="font-bold mb-2 text-gray-700">Document List</h3>
                  @for(item of eftiData.associatedDocument; track item.id?.value) {
                    <div (click)="selectDocument(item)" class="p-3 rounded-md cursor-pointer hover:bg-indigo-50 mb-2 border hover:border-indigo-200 transition-colors">
                      <p class="font-semibold text-indigo-800">{{ item.id?.value || ('Document ' + $index) }}</p>
                      <p class="text-sm text-gray-600">Type: {{ item.typeCode }}</p>
                    </div>
                  } @empty { <p class="text-gray-500 text-center p-4">No associated documents found.</p> }
                }
                @case('charges') {
                  <h3 class="font-bold mb-2 text-gray-700">Service Charges</h3>
                  @for(item of eftiData.applicableServiceCharge; track item.id) {
                    <div (click)="selectServiceCharge(item)" class="p-3 rounded-md cursor-pointer hover:bg-indigo-50 mb-2 border hover:border-indigo-200 transition-colors">
                      <p class="font-semibold text-indigo-800">{{ item.id || ('Charge ' + $index) }}</p>
                      <p class="text-sm text-gray-600">Amount: {{ item.appliedAmount?.[0]?.value | number }} {{ item.appliedAmount?.[0]?.currencyId }}</p>
                    </div>
                  } @empty { <p class="text-gray-500 text-center p-4">No service charges found.</p> }
                }
                @case('movements') {
                  <h3 class="font-bold mb-2 text-gray-700">Transport Movements</h3>
                  @for(item of allMovements; track item.id?.value) {
                    <div (click)="selectMovement(item)" class="p-3 rounded-md cursor-pointer hover:bg-indigo-50 mb-2 border hover:border-indigo-200 transition-colors">
                      <p class="font-semibold text-indigo-800">{{ item.id?.value || ('Movement ' + $index) }}</p>
                      <p class="text-sm text-gray-600">Stage: {{ item.stageCode || 'N/A' }} | Mode: {{ item.usedTransportMeans?.typeCode || 'N/A' }}</p>
                    </div>
                  } @empty { <p class="text-gray-500 text-center p-4">No transport movements found.</p> }
                }
                @case('participants') { <div class="text-center p-10 text-gray-500"><p>Participants details view is not yet implemented.</p></div> }
                @case('journey') { <div class="text-center p-10 text-gray-500"><p>Journey details view is not yet implemented.</p></div> }
                @case('goods') { <div class="text-center p-10 text-gray-500"><p>Goods details view is not yet implemented.</p></div> }
              }
            }

            <!-- DETAIL VIEW -->
            @if(modalDetailView === 'detail') {
              @switch(activeModal) {
                @case('equipment') {
                  @if(selectedEquipment) {
                    @if(selectedCarriedEquipment) {
                      <!-- REMOVED old back button from here -->
                      <h3 class="font-bold mb-2 text-lg">Carried Equipment: {{selectedCarriedEquipment.id?.value}}</h3>
                      <pre class="text-xs bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">{{ selectedCarriedEquipment | json }}</pre>
                    } @else {
                      <h3 class="font-bold mb-2 text-lg">Details for: {{selectedEquipment.id?.value}}</h3>
                      <div class="bg-gray-50 p-3 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-700 border-b pb-1 mb-2">Carried Equipment ({{selectedEquipment.carriedTransportEquipment?.length || 0}})</h4>
                        @if(selectedEquipment.carriedTransportEquipment && selectedEquipment.carriedTransportEquipment.length > 0) {
                          @for(carried of selectedEquipment.carriedTransportEquipment; track carried.id?.value) {
                            <div class="border p-2 rounded-md hover:bg-gray-100 cursor-pointer mb-2" (click)="selectCarriedEquipment(carried)">
                              <p><strong>ID:</strong> {{carried.id?.value}}</p>
                              @if(carried.loadedDangerousGoods && carried.loadedDangerousGoods.length > 0) {
                                <p class="text-red-600 font-bold">[!] Contains Dangerous Goods</p>
                              }
                            </div>
                          }
                        } @else {
                          <p class="text-sm text-gray-500">No carried equipment listed.</p>
                        }
                      </div>
                      <pre class="text-xs bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">{{ selectedEquipment | json }}</pre>
                    }
                  }
                }
                @case('documents') {
                  @if(selectedDocument) {
                    <h3 class="font-bold mb-2 text-lg">Details for: {{selectedDocument.id?.value}}</h3>
                    <pre class="text-xs bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">{{ selectedDocument | json }}</pre>
                  }
                }
                @case('charges') {
                  @if(selectedServiceCharge) {
                    <h3 class="font-bold mb-2 text-lg">Details for: {{selectedServiceCharge.id}}</h3>
                    <pre class="text-xs bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">{{ selectedServiceCharge | json }}</pre>
                  }
                }
                @case('movements') {
                  @if(selectedMovement) {
                    <h3 class="font-bold mb-2 text-lg">Details for: {{selectedMovement.id?.value}}</h3>
                    <pre class="text-xs bg-gray-900 text-white p-4 rounded-lg overflow-x-auto">{{ selectedMovement | json }}</pre>
                  }
                }
              }
            }
          </div>
        </div>
      </div>
    }

    <!-- Reusable template for displaying party details -->
    <ng-template #partyDetails let-party let-title="title">
      @if (party) {
        <div class="bg-gray-50/70 border border-gray-200/80 rounded-lg p-4">
          <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">{{ title }}</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
            <!-- Name -->
            <div class="md:col-span-2">
              <p class="font-semibold text-gray-500">Name</p>
              <p class="text-base text-gray-900">{{ party.name?.[0] || 'N/A' }}</p>
            </div>
            <!-- ID -->
            <div>
              <p class="font-semibold text-gray-500">Identifier</p>
              <p class="text-gray-900">{{ party.id?.value || 'N/A' }} <span class="text-gray-500">({{ party.id?.schemeId || 'N/A' }})</span></p>
            </div>
            <!-- Address -->
            <div>
              <p class="font-semibold text-gray-500">Address</p>
              <p class="text-gray-900">{{ formatAddress(party) }}</p>
            </div>
            <!-- Contact Person -->
            @if(party.definedContactDetails?.personName?.[0]) {
              <div>
                <p class="font-semibold text-gray-500">Contact Person</p>
                <p class="text-gray-900">{{ party.definedContactDetails.personName[0] }}</p>
              </div>
            }
            <!-- Email -->
            @if(party.definedContactDetails?.emailAddress?.[0].completeNumber) {
              <div>
                <p class="font-semibold text-gray-500">Email</p>
                <p class="text-gray-900">{{ party.definedContactDetails.emailAddress[0].completeNumber }}</p>
              </div>
            }
            <!-- Telephone -->
            @if(party.definedContactDetails?.telephone?.[0].completeNumber) {
              <div>
                <p class="font-semibold text-gray-500">Telephone</p>
                <p class="text-gray-900">{{ party.definedContactDetails.telephone[0].completeNumber }}</p>
              </div>
            }
          </div>
        </div>
      } @else {
        <p class="text-gray-500 text-center p-4">Information for this participant is not available.</p>
      }
    </ng-template>

  </div>
} @else {
  <div class="p-6 text-center text-gray-500">
    <p>eFTI data is not available or is loading.</p>
  </div>
}
